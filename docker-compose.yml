# VibeCodeManager Docker Compose Configuration
#
# Usage:
#   Development shell:     docker compose run --rm shell
#   Build Linux packages:  docker compose run --rm build-linux
#
# The build-linux service outputs packages directly to ./dist on the host.
#
# Note: VibeCodeManager is an Electron desktop application. Docker is primarily useful for:
#   - Building Linux packages in a consistent environment
#   - CI/CD pipelines
#   - Development environment setup
#
# For running the desktop app, use native installation instead.

services:
  # Development shell - interactive environment for development
  shell:
    build:
      context: .
      target: development
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - desktop_node_modules:/app/apps/desktop/node_modules
      - mobile_node_modules:/app/apps/mobile/node_modules
      - shared_node_modules:/app/packages/shared/node_modules
      - cargo_cache:/root/.cargo
      - rust_target:/app/apps/desktop/vibecode-rs/target
    environment:
      - NODE_ENV=development
    stdin_open: true
    tty: true
    command: /bin/bash

  # Build Linux packages
  build-linux:
    build:
      context: .
      target: development
    volumes:
      - ./dist:/app/apps/desktop/dist
    environment:
      - NODE_ENV=production
    # Note: We explicitly build AppImage and deb only. Snap builds require snapcraft
    # which adds significant complexity. For snap packages, use native environment or CI/CD.
    command: >
      sh -c "cd apps/desktop &&
             pnpm exec electron-builder install-app-deps &&
             pnpm run typecheck &&
             pnpm run test:run &&
             pnpm exec electron-vite build &&
             pnpm exec electron-builder --linux AppImage deb --config electron-builder.config.cjs"

# Named volumes for caching
# Note: The 'artifacts' Docker stage is available for CI/CD pipelines that build
# the full image. For local development, use 'build-linux' which outputs directly to ./dist.
volumes:
  node_modules:
  desktop_node_modules:
  mobile_node_modules:
  shared_node_modules:
  cargo_cache:
  rust_target:

